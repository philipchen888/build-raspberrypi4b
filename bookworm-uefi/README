Build bookworm-uefi sdcard image for raspberrypi4b:

cd ~/Downloads
wget https://cdimage.debian.org/debian-cd/current/arm64/iso-cd/debian-12.11.0-arm64-netinst.iso
wget https://github.com/pftf/RPi4/releases/download/v1.42/RPi4_UEFI_Firmware_v1.42.zip

cd ~/build-raspberrypi4b/bookworm-uefi

Plugin USB2 SATA ssd to PC.
sudo ./mksdcardimg.sh
sudo mkfs.vfat /dev/sda1
sudo fdisk -l /dev/sda
sudo mount -t vfat /dev/sda1 /mnt
cd /mnt
sudo 7z x ~/Downloads/debian-12.11.0-arm64-netinst.iso
sudo 7z x ~/Downloads/RPi4_UEFI_Firmware_v1.42.zip
cd ~/build-raspberrypi4b/bookworm-uefi
sync
sudo umount /mnt
Eject USB2 SATA ssd from PC.

------------------------------------------------------------------------
Install bookworm to USB2 SATA ssd.
NOTE: To minimize EMI interference, put USB2 sata ssd to rpi4b bottom USB2 socket,
      Put keyboard mouse to rpi4b bottom USB3 socket with USB2 extention cable.
------------------------------------------------------------------------

Plugin USB2 sata ssd and ethernet cable to rpi4b. Power on rpi4b.
Esc -> Device Manager -> Rpi -> Advanced -> 3GB ( disable ) -> F10 -> Boot Manager -> first UEFI or SDCARD.
Select install
loading missing firmware? No
Select debian desktop and gnome in addition to ssh and standard system utilities.
User name: linaro

Disable power saving, auto suspend and screen saver.
su -
usermod -aG adm,sudo,video linaro
sync
shutdown -h now

Plugin USB2 sata ssd to PC.
sudo cp ./packages/brcmfmac43455-sdio.txt /media/$USER/*/lib/firmware/brcm/
sudo cp ./packages/BCM4345C0.hcd /media/$USER/*/lib/firmware/brcm/
cd /media/$USER/*/lib/firmware
sudo mkdir rtl_bt
sudo cp /home/$USER/build-raspberrypi4b/bookworm-uefi/packages/rtl* ./rtl_bt
ls -la ./rtl_bt
cd
sync 
sudo umount /media/$USER/*
Eject USB2 sata ssd from PC. 

Plugin USB2 sata ssd to rpi4b, Unplug ethernet cable from rpi4b. Power on rpi4b.
Setup wifi.
sudo apt install openssh-server net-tools
sudo ifconfig
uname -a
lsb_release -a
sudo apt update; sudo apt upgrade; sudo apt install pulseaudio-utils;
sync
free
Check if Debian is running UEFI mode:
ls /sys/firmware/efi
Check display mode: ( wayland or x11 )
echo $XDG_SESSION_TYPE
Check audio driver: ( pulseaudio or pipewire )
pactl info

sudo apt install build-essential speedtest-cli python3-pip python3-setuptools ffmpeg mpv glmark2-es2 pandoc vlc vlc-plugin-video-output pavucontrol rfkill

speedtest-cli --secure

glmark2-es2

aplay -l

sudo rfkill list

mainline kernel 6.1.0-38-arm64 doesn't support rpi4b sound, bluetooth.

---------------------------------------------------------------
Install vendor kernel 6.16.0-v8+
---------------------------------------------------------------

sudo apt install git cmake device-tree-compiler libfdt-dev build-essential libncurses-dev bison flex libssl-dev libelf-dev fakeroot

git clone https://github.com/raspberrypi/linux --depth=1 -b rpi-6.16.y
vi ./linux/arch/arm64/configs/bcm2711_defconfig ( delete CONFIG_CMDLINE, change CONFIG_I2C_CHARDEV=m to CONFIG_I2C_CHARDEV=y )

Install ovmerge from  https://github.com/raspberrypi/utils
git clone https://github.com/raspberrypi/utils.git
sudo apt install libgnutls28-dev
cd utils
cmake .
make
sudo make install
which ovmerge
cd ../linux/arch/arm/boot/dts/broadcom
cp bcm2711-rpi-4-b.dts bcm2711-rpi-4-b.dts.org
ovmerge -c -p bcm2711-rpi-4-b.dts,i2c1=on,i2c_arm=on,spi=on,audio=on ../overlays/uart2-overlay.dts ../overlays/vc4-kms-v3d-pi4-overlay.dts,cma-512 ../overlays/pwm-2chan-overlay.dts,pin=12,func=4,pin2=13,func2=4 > custom.dts
cp custom.dts bcm2711-rpi-4-b.dts
cd ~/linux
sudo make mrproper
make ARCH=arm64 bcm2711_defconfig
make ARCH=arm64 all -j$(nproc)        ( this may take 4 hours to compile )
sudo make ARCH=arm64 modules_install
sudo make ARCH=arm64 dtbs_install
sudo make ARCH=arm64 install

cd ../
ls -la /boot
df .
sudo e2label /dev/sda2 rootfs
sudo blkid /dev/sda2   ( look for LABEL and UUID )

sudo vi /etc/grub.d/40_custom_uuid ( add
#!/bin/sh
exec tail -n +3 $0

menuentry "Boot from UUID" {
    search --no-floppy --fs-uuid --set=root --hint='usb0,gpt2' --hint='mmcblk0,gpt2' --hint='mmcblk1,gpt2' a954378c-c6a9-4649-936d-29b385dd5f3d
    echo    'Loading Linux 6.16.0-v8+ ...'
    linux /boot/vmlinuz-6.16.0-v8+ root=LABEL=rootfs rootwait rw
    echo    'Loading initial ramdisk ...'
    initrd /boot/initrd.img-6.16.0-v8+
    devicetree /boot/dtbs/6.16.0-v8+/broadcom/bcm2711-rpi-4-b.dtb
}
)

Note: change the above UUID to real UUID like: b3adbe54-ab88-4da5-a9a6-08cf87a09d69

sudo chmod +x /etc/grub.d/40_custom_uuid

sudo vi /etc/default/grub ( change GRUB_DEFAULT=0 to GRUB_DEFAULT="Boot from UUID" )
sudo update-grub  ( generate grub.cfg )
cd
sync
sudo shutdown -h now

Power on rpi4b.
uname -a
lsb_release -a
sudo cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq
Check if Debian is running UEFI mode:
ls /sys/firmware/efi

sudo apt install git zip rfkill speedtest-cli python3-pip python3-setuptools ffmpeg mpv glmark2-es2-wayland pandoc firefox-esr vlc vlc-plugin-video-output

speedtest-cli --secure

glmark2-es2-wayland

aplay -l
pavucontrol  ( select hdmi as default )

firefox -> youtube.com -> search YmDNhi07_Ho

git clone https://github.com/yt-dlp/yt-dlp.git
cd yt-dlp
make
cd ../
~/yt-dlp/yt-dlp -f 'bestvideo[ext=mp4][protocol=https]+bestaudio[ext=m4a][protocol=https]' 3qrKjywjo7Q -o swan.mp4 --postprocessor-args " -c:v h264_v4l2m2m -b:v 2M -c:a copy"
mpv --hwdec=v4l2m2m-copy --log-file=mpv.log swan.mp4
grep Using mpv.log
cvlc --gl=wgl --glconv=any swan.mp4

Plugin ASUS USB-BT500 bluetooth usb dongle to rpi4b.
sudo rfkill list
hciconfig hci1
hcitool dev
hciconfig -a
